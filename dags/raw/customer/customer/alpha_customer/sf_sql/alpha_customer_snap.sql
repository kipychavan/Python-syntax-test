merge into {{ params.snowDB }}.{{ params.snowSchema }}.{{ params.snowTable }} as TGT
using (select * from (select *,row_number() over(partition by HOUSE_ID,CUSTOMER_ID
order by HOUSE_ID,CUSTOMER_ID ) as r  from
 {{ params.snowDB }}.{{ params.snowSchema }}.{{ params.snowHistTablestream }})where r=1) as SRC
on SRC.HOUSE_ID =  TGT.HOUSE_ID AND SRC.CUSTOMER_ID =  TGT.CUSTOMER_ID
when matched and SRC."METADATA$ACTION" = 'INSERT' then update set 
CDC_FUNC = SRC.CDC_FUNC,
CUSTOMER_ID = SRC.CUSTOMER_ID,
HOUSE_ID = SRC.HOUSE_ID,
CUSTOMER_NAME = SRC.CUSTOMER_NAME,
CUSTOMER_ADDRESS = SRC.CUSTOMER_ADDRESS,
CUSTOMER_ADDRESS_2 = SRC.CUSTOMER_ADDRESS_2,
CUSTOMER_CITY = SRC.CUSTOMER_CITY,
CUSTOMER_STATE = SRC.CUSTOMER_STATE,
ZIP_CODE = SRC.ZIP_CODE,
PHONE_NUMBER = SRC.PHONE_NUMBER,
FAX_NUMBER = SRC.FAX_NUMBER,
EMAIL = SRC.EMAIL,
BF_ID = SRC.BF_ID,
WINE_VOLUME_ID = SRC.WINE_VOLUME_ID,
LIQUOR_VOLUME_ID = SRC.LIQUOR_VOLUME_ID,
ETHNIC_ID = SRC.ETHNIC_ID,
CHAIN_STORE_ID = SRC.CHAIN_STORE_ID,
LIC_TYPE_ID = SRC.LIC_TYPE_ID,
CUST_TYPE_ID = SRC.CUST_TYPE_ID,
LICENSEE_NAME = SRC.LICENSEE_NAME,
STORE_NUMBER = SRC.STORE_NUMBER,
NATIONAL_ACCOUNT_ID = SRC.NATIONAL_ACCOUNT_ID,
UDV_CHAINGROUP_ID = SRC.UDV_CHAINGROUP_ID,
ACCOUNT_STATUS = SRC.ACCOUNT_STATUS,
ROUTE_NUM = SRC.ROUTE_NUM,
SECOND_ROUTE = SRC.SECOND_ROUTE,
THIRD_ROUTE = SRC.THIRD_ROUTE,
LIQ_LICENSE = SRC.LIQ_LICENSE,
WINE_LICENSE = SRC.WINE_LICENSE,
LIC_EXPIRE_DATE = SRC.LIC_EXPIRE_DATE,
PRICE_CODE = SRC.PRICE_CODE,
TERMS_CODE = SRC.TERMS_CODE,
ALT_TERMS_CODE = SRC.ALT_TERMS_CODE,
WHSE_BRANCH = SRC.WHSE_BRANCH,
WHSE_CUSTOMER_NUMBER = SRC.WHSE_CUSTOMER_NUMBER,
HARDWIRE_SEG = SRC.HARDWIRE_SEG,
KEY_ACCT_FLAG = SRC.KEY_ACCT_FLAG,
DEAL_TYPE = SRC.DEAL_TYPE,
ROUNDHOUSE_MAX_SEG = SRC.ROUNDHOUSE_MAX_SEG,
ROUNDHOUSE_MIN_SEG = SRC.ROUNDHOUSE_MIN_SEG,
COST_CODE = SRC.COST_CODE,
AR_COMBO_CODE = SRC.AR_COMBO_CODE,
COUNTY_CODE = SRC.COUNTY_CODE,
CITY_CODE = SRC.CITY_CODE,
BOTTLE_DISCOUNT = SRC.BOTTLE_DISCOUNT,
DISCOUNT_TYPE = SRC.DISCOUNT_TYPE,
DISCOUNT_CODE = SRC.DISCOUNT_CODE,
ACCOUNT_MANAGER_ID = SRC.ACCOUNT_MANAGER_ID,
BEER_VOLUME_ID = SRC.BEER_VOLUME_ID,
SUB_PREMISE_ID = SRC.SUB_PREMISE_ID,
PREMISE_ID = SRC.PREMISE_ID,
CREATED_DATE = SRC.CREATED_DATE,
AREA_ID = SRC.AREA_ID,
DEMO_ID = SRC.DEMO_ID,
NA_VOLUME_ID = SRC.NA_VOLUME_ID,
PRICING_PREMISE_CODE = SRC.PRICING_PREMISE_CODE,
DEPARTMENT_NUMBER = SRC.DEPARTMENT_NUMBER,
SHELF_TIER_ID = SRC.SHELF_TIER_ID,
INTERNAL_NAME = SRC.INTERNAL_NAME,
EFT_FLAG = SRC.EFT_FLAG,
CUST_SAMPLE = SRC.CUST_SAMPLE,
CUSTOMER_SUPPLIER_ID = SRC.CUSTOMER_SUPPLIER_ID,
REDBULL_SHELF_TIER_ID = SRC.REDBULL_SHELF_TIER_ID,
AUTHORIZED_ITEM_FLAG = SRC.AUTHORIZED_ITEM_FLAG,
ETL_UPDATE_DATE = current_timestamp(), 
ETL_UPDATE_USER_ID = current_user(), 
ETL_TASK_RUN_ID = SRC.ETL_TASK_RUN_ID, 
ETL_ROW_HASH = SRC.ETL_ROW_HASH, 
RAW_FILE_NAME = SRC.RAW_FILE_NAME
 
WHEN NOT MATCHED AND SRC."METADATA$ACTION" = 'INSERT' THEN INSERT 
(
"CDC_FUNC",
"CUSTOMER_ID",
"HOUSE_ID",
"CUSTOMER_NAME",
"CUSTOMER_ADDRESS",
"CUSTOMER_ADDRESS_2",
"CUSTOMER_CITY",
"CUSTOMER_STATE",
"ZIP_CODE",
"PHONE_NUMBER",
"FAX_NUMBER",
"EMAIL",
"BF_ID",
"WINE_VOLUME_ID",
"LIQUOR_VOLUME_ID",
"ETHNIC_ID",
"CHAIN_STORE_ID",
"LIC_TYPE_ID",
"CUST_TYPE_ID",
"LICENSEE_NAME",
"STORE_NUMBER",
"NATIONAL_ACCOUNT_ID",
"UDV_CHAINGROUP_ID",
"ACCOUNT_STATUS",
"ROUTE_NUM",
"SECOND_ROUTE",
"THIRD_ROUTE",
"LIQ_LICENSE",
"WINE_LICENSE",
"LIC_EXPIRE_DATE",
"PRICE_CODE",
"TERMS_CODE",
"ALT_TERMS_CODE",
"WHSE_BRANCH",
"WHSE_CUSTOMER_NUMBER",
"HARDWIRE_SEG",
"KEY_ACCT_FLAG",
"DEAL_TYPE",
"ROUNDHOUSE_MAX_SEG",
"ROUNDHOUSE_MIN_SEG",
"COST_CODE",
"AR_COMBO_CODE",
"COUNTY_CODE",
"CITY_CODE",
"BOTTLE_DISCOUNT",
"DISCOUNT_TYPE",
"DISCOUNT_CODE",
"ACCOUNT_MANAGER_ID",
"BEER_VOLUME_ID",
"SUB_PREMISE_ID",
"PREMISE_ID",
"CREATED_DATE",
"AREA_ID",
"DEMO_ID",
"NA_VOLUME_ID",
"PRICING_PREMISE_CODE",
"DEPARTMENT_NUMBER",
"SHELF_TIER_ID",
"INTERNAL_NAME",
"EFT_FLAG",
"CUST_SAMPLE",
"CUSTOMER_SUPPLIER_ID",
"REDBULL_SHELF_TIER_ID",
"AUTHORIZED_ITEM_FLAG",
"ETL_CREATE_DATE", 
"ETL_CREATE_USER_ID", 
"ETL_UPDATE_DATE", 
"ETL_UPDATE_USER_ID", 
"ETL_TASK_RUN_ID",
"ETL_ROW_HASH", 
"RAW_FILE_NAME"
)
VALUES
(
"CDC_FUNC",
"CUSTOMER_ID",
"HOUSE_ID",
"CUSTOMER_NAME",
"CUSTOMER_ADDRESS",
"CUSTOMER_ADDRESS_2",
"CUSTOMER_CITY",
"CUSTOMER_STATE",
"ZIP_CODE",
"PHONE_NUMBER",
"FAX_NUMBER",
"EMAIL",
"BF_ID",
"WINE_VOLUME_ID",
"LIQUOR_VOLUME_ID",
"ETHNIC_ID",
"CHAIN_STORE_ID",
"LIC_TYPE_ID",
"CUST_TYPE_ID",
"LICENSEE_NAME",
"STORE_NUMBER",
"NATIONAL_ACCOUNT_ID",
"UDV_CHAINGROUP_ID",
"ACCOUNT_STATUS",
"ROUTE_NUM",
"SECOND_ROUTE",
"THIRD_ROUTE",
"LIQ_LICENSE",
"WINE_LICENSE",
"LIC_EXPIRE_DATE",
"PRICE_CODE",
"TERMS_CODE",
"ALT_TERMS_CODE",
"WHSE_BRANCH",
"WHSE_CUSTOMER_NUMBER",
"HARDWIRE_SEG",
"KEY_ACCT_FLAG",
"DEAL_TYPE",
"ROUNDHOUSE_MAX_SEG",
"ROUNDHOUSE_MIN_SEG",
"COST_CODE",
"AR_COMBO_CODE",
"COUNTY_CODE",
"CITY_CODE",
"BOTTLE_DISCOUNT",
"DISCOUNT_TYPE",
"DISCOUNT_CODE",
"ACCOUNT_MANAGER_ID",
"BEER_VOLUME_ID",
"SUB_PREMISE_ID",
"PREMISE_ID",
"CREATED_DATE",
"AREA_ID",
"DEMO_ID",
"NA_VOLUME_ID",
"PRICING_PREMISE_CODE",
"DEPARTMENT_NUMBER",
"SHELF_TIER_ID",
"INTERNAL_NAME",
"EFT_FLAG",
"CUST_SAMPLE",
"CUSTOMER_SUPPLIER_ID",
"REDBULL_SHELF_TIER_ID",
"AUTHORIZED_ITEM_FLAG",
current_timestamp(), 
current_user(), 
null, 
null, 
"ETL_TASK_RUN_ID",
"ETL_ROW_HASH", 
"RAW_FILE_NAME"
)